<!DOCTYPE html>
<html>

<head>

	<title>Michigan Air Permit Violation Dashboard</title>
	<meta name="description" content="Explore violation notices issued to air polluters throughout the state, and check for new violations daily."/>
    <meta property="og:title" content="Planet Detroit's Air Permit Violation Dashboard" />
    <meta property="og:description" content="Use our interactive map to explore violation notices issued to air polluters throughout the state, and check back daily for the most recent violations." />
    <meta property="og:type" content="article"/>
    <meta property="og:image" content="https://github.com/Planet-Detroit/air-permit-violation-dashboard/blob/main/img/planet-detroit-air-violation-dashboard-01.jpg?raw=true" />
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:creator" content="@PlanetDetroit"/>
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.svg">
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src='https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.5/turf.min.js'></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="module" src="https://md-block.verou.me/md-block.js"></script>
 
	<link rel="stylesheet" href="docs/violation-map.css">

</head>

<body>

<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<div id="nav">
    <a href="https://planetdetroit.org/" class="home-link" target="_blank">
		<img src = "img/PlanetDetroitLogo.svg" style="width:140px;margin:0 auto;display:inline-flex;"/>
	</a>
</div>
<div id="intro-container">
	<div id="small-screen-alert">
		<p>For the best interactive experience, please load this map on a larger screen.
			 Some functionality may be impaired when viewing on a mobile device.</p>
	</div>
	<div id="title-mobile">
		<h1 style="text-align:center;">Michigan Air Permit Violations</h1>
		<h2 style="text-align:center;">2018 - PRESENT</h2>
	</div>
	<div id="intro-mobile">
		<h2>Welcome to Planet Detroit's interactive map of Michigan air permit violations.</h2>
		<p>This map updates daily with new violation notices issued by EGLE
			to companies that hold permits to pollute the air throughout the state.</p>
		<p><a class="recent-vns" href="#recent-vns">View the most recent violations.</a></p>
		<p>Violation notices may be about excessive air pollution, failure to keep records,
			maintain equipment, renew permits and more.</p>
			<p>Each circle represents one facility and is sized by the number of violation notices
				the company received since 2018.</p>
			<p>Click on the circles to read more about the specific violations
				as well as find links to each document. Or search for a location and 
				browse the facilities nearby. Text about the source will appear below the map.</p>
			<p><em>There are more sources of air pollution in Michigan
				than are on the map, as they might not have had a violation in the past five years.
				Learn more about them by browsing <a href="https://www.tinyurl.com/egle-air-documents" target="_blank" class="article">this dataset</a>
				 of EGLE's Air Quality Division documents.</em></p>
		<br/>
	</div>
				<div class="spacer"></div>

	<div id = "mobile-legend">
		<div>
				<!-- <div class="spacer"></div> -->
            <h4>Violation Notices Issued Since 2018</h4>
			<p>Click on a facility for details about its violation notices.</p>
			<img src="img/legend-dots-02.svg" style="width:100%;margin:0 auto;"/>
        </div>
        <div>
            <h4>EPA Classification</h4>
			<p><button id="epaButton2">Read more</button> about these categories.</p>
            <div class="source-legend"><span style="background-color: #8F0043"></span>Megasite</div>
            <div class="source-legend"><span style="background-color: #FF0037"></span>Major Source</div>
            <div class="source-legend"><span style="background-color: #FF5400"></span>Synthetic Minor Source</div>
            <div class="source-legend"><span style="background-color: #FFBD00"></span>True Minor Source</div>
        </div>
	</div>
</div>
<div class="map-container">
	<div id='map'>
		<div id="dropdown">
			<select id="select-menu">
				<option value="">All Sources</option>
			</select>
		</div>
		<div class="legend-container">
		<div id="violations-legend" class="legend2">
            <h4>Violation Notices Issued <br/>Since 2018</h4>
			<p>Click on a facility for details about its violation notices.</p>
			<img src="img/legend-dots-02.svg" style="width:80%;margin:0 auto;"/>
        </div>
        <div id="epa-class-legend" class="legend1">
            <h4>EPA Classification</h4>
			<p><button id="epaButton">Read more</button> about these categories.</p>
            <div><span style="background-color: #8F0043"></span>Megasite</div>
            <div><span style="background-color: #FF0037"></span>Major Source</div>
            <div><span style="background-color: #FF5400"></span>Synthetic Minor Source</div>
            <div><span style="background-color: #FFBD00"></span>True Minor Source</div>
        </div>
		<!-- <hr/> -->
		<div id= "data-source">
			<p>Source: EGLE's database of <a href="https://www.shelbyjouppi.com/egle-air-database" target="_blank">air polluter documents.</a></p>
		</div>
		</div>


	</div>
	<!-- The Modal -->
	<div id="epaPopup" class="modal">

		<!-- Modal content -->
		<div class="modal-content">
		<span class="close">&times;</span>
		<h4>The EPA classifies sources of air pollution large enough to require a permit into four categories.</h4>
		<p><span class="highlight-1">Megasites</span> are the most severe of the EPA classifications. 
			These are considered "extremely large, complex facilities" that emit air pollutants at a Major Source scale.</p>

		<p><span class="highlight-2">Major Sources</span> are classified as such when they emit more than 10 tons per year 
			of a Hazardous Air Pollutant (HAP)<sup>*</sup>, more than 25 tons per year of a combination of HAPs, or more than 
			100 tons of all air pollutants. </p>

		<p><span class="highlight-3">Synthetic Minor Sources</span> have the capacity to pollute like a Major Source, 
			but the company has agreed to limit its emissions. If the facility were to violate its permit 
			and emit more than allowed, it could be polluting as much as a Major Source.</p>

		<p><span class="highlight-4">True Minor Sources</span> do not have the capacity to pollute like a Major Source,
		but emit enough air pollution to require a permit.</p>
		<br/>
		<hr/>
		<p><span class="caption">Source: <a href="https://www.epa.gov/sites/default/files/2013-09/documents/cmspolicy.pdf" target="_blank" class="article">The Clean Air Act Stationary Source Compliance Monitoring Strategy.</a></span></p>
		<p><span class="caption"><sup>*</sup>Hazardous air pollutants are those known to cause cancer or other serious health problems. 
			<a href="https://www.epa.gov/haps/initial-list-hazardous-air-pollutants-modifications" target="_blank" class="article">
			See the EPA's list of 188 HAPs.</a> Other air pollutants are known to cause significant health problems 
			in large quanities, like particulate matter, carbon monoxide and sulfur dioxide.</span></p>
			<!-- Researchers are studying the cumulative impact of so many sources 
			of air pollution concentrated in areas <a href ="https://graham.umich.edu/activity/13265" target="_blank" class="article">like Detroit.</a></em></p> -->
		</div>
	
	</div>
	<div id='articlePlace'>
        <div id="epa-class"></div>
		<div id="company-profile">
			<div id="title-desktop">
				<h1 style="text-align:center;">Michigan Air Permit Violations</h1>
				<h2 style="text-align:center;">2018 - PRESENT</h2>
			</div>
		</div>
		<div id="company-violations">
			<div id="intro-desktop">
				<h2>Welcome to Planet Detroit's interactive map of Michigan air permit violations.</h2>
				<p>This map updates daily with new violation notices issued by EGLE
					to companies that hold permits to pollute the air throughout the state.</p>
				<p><a class="recent-vns" href="#recent-vns">View the most recent violations.</a></p>
				<p>Violation notices may be about excessive air pollution, failure to keep records,
					maintain equipment, renew permits and more.</p>
				<p>Each circle represents one facility and is sized by the number of violation notices
					the company received since 2018.</p>
				<p>Click on the circles to read more about the specific violations
					as well as find links to each document. Or search for a location and 
				    browse the facilities nearby.</p>
				<p><em>There are more sources of air pollution in Michigan
				    than are on the map, as they might not have had a violation in the past five years.
				    Learn more about them by browsing <a href="https://www.tinyurl.com/egle-air-documents" target="_blank" class="article">this dataset</a>
					 of EGLE's Air Quality Division documents. </em></p>
			</div>
		</div>
		<div id="learn">
			<p>Please note this map was created with the help of automation
				 technology that is wonderful but imperfect. 
				 <a href ="https://github.com/Planet-Detroit/air-permit-violation-dashboard/#a-few-notes-regarding-our-methodology" target="_blank" class="article">Read more</a> about caveats, methodology and how to report any issues.</p>
		</div>
	</div>
</div>
<div id="content-container">
	<br/>
	<div class="spacer"></div>
	<!-- <hr/> -->
	<a name="recent-vns"></a>
	<div id="recent-violations-header">
		<h4>Most Recent Violation Notices</h4>
		<hr/>
		<!-- <p>Here are the top six violation notices issued most recently.</p> -->
	</div>
    <div id="recent-violations">
    </div>
	<br/>
	<hr/>
	<div id="about-project">
	<h4>About the project</h4>

	<p>Thousands of sources of air pollution operate in Michigan under a permit.
	EGLE's Air Quality Division routinely inspects, reviews emission data and 
	responds to complaints about these facilities. Sometimes they issue violation
	notices if a company has violated one of the terms of its permit.</p>

	<p>It could be that the source has emitted more air pollution than is allowed, 
	or failed to track its emissions, maintain equipment or aquire a permit in the first place.</p>

	<p>These violations are public record, but they are not easy to find as they live in a <a class="article" href="https://www.egle.state.mi.us/aps/downloads/SRN/" target="_blank">system of folders</a>
		on EGLE's database. Planet Detroit's Air Permit Violation Dashboard is an attempt 
		to make this information more accessible.</p>
		
		<p>The map and recent violations update on a daily basis and shows sources of air pollution that have violated
		their permits since 2018. You can find more information about these facilities 
		and others by browsing the <a class="article" href="https://www.tinyurl.com/egle-air-documents" target="_blank">full dataset</a>  
		for inspection reports, enforcement notices, older violations and more.	<em>Pro Tip: Filter for a specific facility by using its "SRN" or State Registration Number located
		at the top right of their profile on the map.</em>
	 </p>

	<p> <a class="article" href="https://github.com/Planet-Detroit/air-permit-violation-dashboard/#readme" target="_blank">
		Read the full methodology and access our data on Github.</a> And please <a class="article" href="https://planetdetroit.org/contact-us/" target="_blank">reach out to us</a> with any questions about the dashboard.
		If you have a specific error to report, please submit it to this form and we will address it as soon as possible.</p>
	<p>
	
	 <hr/>
	 <p><em>Data collection, automation and dashboard design by <a class="article" target="_blank" href="https://www.shelbyjouppi.com">Shelby Jouppi.</a> Editing by <a href="https://planetdetroit.org/author/nina-ignaczak/" target="_blank" class="article">Nina Ignaczak.</a></em>
	</p>
	</div>
</div>
<div class="spacer"></div>

<div id="footer">
	<div id="footer-about">
		<img src="img/PlanetDetroitLogo-WhiteText-2.svg" style="width:200px;"/>
		<p>
			Our mission is to produce quality climate, 
			equity, health and environment journalism in 
			the public interest that centers grassroots voices,  
			holds power accountable, spotlights solutions
			+ serves the community.
		</p>
	</div>
	<div id="footer-newsletter">
		<h4>Get smarter about your environment and your health</h4>

		<p>
			Our newsletters provide accountability, solutions-based 
			and community journalism around local climate, 
			environmental and public health issues in 
			Detroit and Michigan.
		</p>
		<br/>
		<p>
		<a class="button-blue" href="https://planetdetroit.org/our-sponsors/" target="_blank">Sign up for free</a>
		</p>
	</div>
	<div id="footer-nav">
		<ul>
		<li><a href="https://planetdetroit.org/about-us/" target="_blank">About Us</a></li>
		<li><a href="https://planetdetroit.org/contact-us/" target="_blank">Contact Us</a></li>
		<li><a href="https://planetdetroit.org/wp-content/uploads/2023/06/Planet-Detroit-2019-2023-Impact-Report.pdf" target="_blank">2023 Impact Report</a></li>
		<li><a href="https://planetdetroit.org/our-sponsors/" target="_blank">Our Funders, Partners and Sponsors</a></li>
		<li><a href="https://planetdetroit.org/impactpartners/" target="_blank">Impact Partners Circle</a></li>
		</ul>
		<br/>
		<p>
		<a class="button-green" href="https://planetdetroit.org/support-planet-detroit/" target="_blank">Become a Planet Detroiter</a>
		</p>
	</div>
</div>
<div id="footer-copyright">
	Copyright Â© 2023 Planet Detroit
</div>
	<!-- Loading Data -->
	<script type="text/javascript" src="output/violation-map-geo-data.js"></script>
	<script type="text/javascript" src="output/recent-violations.js"></script>

	<!-- Loading Map -->
	<script type="text/javascript">
		
		// mapboxgl.accessToken = 'pk.eyJ1IjoiZGF0YW1hbWExMTYiLCJhIjoiY2xnZmU0b3RvMDBwZDNna3h4bWc5eDh2MyJ9.PBGhYjmYNCs4dL3cE04zxw';
		mapboxgl.accessToken = 'pk.eyJ1IjoiZGF0YW1hbWExMTYiLCJhIjoiY2xncXMxM21rMTFhZDNybGh6cmE4YjZreCJ9.XPLngEtaW3V0Xd2vBDaxMQ'
		
		var map = new mapboxgl.Map({
			container: 'map', // HTML container ID
			style:'mapbox://styles/datamama116/cll62uwv8008r01r8drpohcph',
			center: [-83.6136, 43.7833], // starting position as [lng, lat]
			bbox:[-90.418136, 41.696118, -82.413474, 48.2388],
			zoom: 12,
			maxZoom: 16,
		});

				// disable map rotation using right click + drag
		map.dragRotate.disable();
		
		// disable map rotation using touch rotation gesture
		map.touchZoomRotate.disableRotation();
		// Define bounds that conform to the `LngLatBoundsLike` object.
		const bounds = [
		[-91, 40], // [west, south]
		[-80, 49]  // [east, north]
		];
		// Set the map's max bounds.

		map.setMaxBounds(bounds);

		// Add the control to the map.
		map.addControl(
		new MapboxGeocoder({
			
		accessToken: mapboxgl.accessToken,
		mapboxgl: mapboxgl,
		zoom: 12,
		countries: 'us',
		bbox: [-90.418136, 41.696118, -82.413474, 48.2388],
		limit:10,
		types: 'poi,place,address',
	
		})
		);


// Functions
		var popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: true });

		let hoverCurrentId = null
		var datalayer;
		// var circleSelected;

		function updateArticle(e) {
			let feature = e.features[0]
            var group_id = feature.properties.group_id
			var group_name = feature.properties.group_name
            var srn = feature.properties.srn
            var violation_count = feature.properties.violationCount
            var address = feature.properties.address_full
            var facility_name = feature.properties.facility_name
            var violation_article = feature.properties.violation_article

            // if (group_id == 4) {
            //     document.getElementById("articlePlace").innerHTML = `<div class="epa-class-${group_id}"><h3 class="epa-class-dark">${group_name}</h3><h3 class="srn-dark">SRN: ${srn}</h3></div>`
            // }
            // else {
            //     document.getElementById("articlePlace").innerHTML = `<div class="epa-class-${group_id}"><h3 class="epa-class">${group_name}</h3><h3 class="srn">SRN: ${srn}</h3></div>`

            // }
            if (group_id == 4) {
                if (violation_count > 1) {
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class-dark">${group_name}</h3><h3 class="srn-dark">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notices</h2></div><div id="company-violations">${violation_article}</div>`
                }
                else {
                    
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class-dark">${group_name}</h3><h3 class="srn-dark">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notice</h2></div><div id="company-violations">${violation_article}</div>`
                }
            }
            else {
                if (violation_count > 1) {
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class">${group_name}</h3><h3 class="srn">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notices</h2></div><div id="company-violations">${violation_article}</div>`
                }
                else {
                    
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class">${group_name}</h3><h3 class="srn">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notice</h2></div><div id="company-violations">${violation_article}</div>`
                }
            }

            learn = `<div id='learn'><h4>Want to Learn More About This Facility?</h4><p>Find inspection reports, older violations and other documents for ${facility_name} in <a href="https://www.egle.state.mi.us/aps/downloads/SRN/${srn}" target="_blank">EGLE's database</a>, and use the <a href="https://www.michigan.gov/egle/-/media/Project/Websites/egle/Documents/Programs/AQD/misc-info/file-naming-convention.pdf" target="_blank">file naming conventions</a> to decode the documents.</p><br/><h4>Explore documents for more than 4,000 permitted sources</h4> <p>Browse this <a href="https://www.tinyurl.com/egle-air-documents" target="_blank">Google sheet</a> or download the data from <a href="https://github.com/srjouppi/michigan-egle-database-auto-scraper#open_file_folder-output" target="_blank">Github.</a> Pro Tip: If you're looking for this facility, filter by its State Registration Number (SRN): ${srn}</p></div>`
            document.getElementById("articlePlace").innerHTML = article + learn
			// document.getElementById("articlePlace").innerHTML = feature.properties.article + "<div id='learn'><h4>Want to Learn More About this Facility?</h4><p>Find staff reports, tests, and more by searching <a href='https://www.tinyurl.com/egle-air-documents' target='_blank'>this dataset</a> of EGLE documents pertaining to air pollters throughout the state.</p><p><em>Pro tip: Filter using the facility's unique State Registration Number (SRN) located at the top right corner of this profile.</em></p></div>"
			articlePlace.scrollTop = 0

		}
		// epaClass = document.getElementByID("epa-class")
		// $('epaClass:empty').hide();
		function startHover(e) {
			let feature = e.features[0]

			if (hoverCurrentId) {
				map.setFeatureState({ source: 'datalayer', id: hoverCurrentId }, { hover: false });
			}
			hoverCurrentId = feature.id
			map.setFeatureState({ source: 'datalayer', id: hoverCurrentId }, { hover: true });
		}

		function stopHover(e) {
			if (hoverCurrentId) {
				map.setFeatureState({ source: 'datalayer', id: hoverCurrentId }, { hover: false });
			}
			hoverCurrentId = null;
		}

		// Draw Popup
		function drawPopup(e) {
			let feature = e.features[0]
			map.getCanvas().style.cursor = 'pointer';
			var coordinates = e.lngLat;//turf.centerOfMass(feature);
			var headline = feature.properties.facility_name;
			var violationCount = feature.properties.violationCount
			var group_id = feature.properties.group_id
			var group_name = feature.properties.group_name
			var group_name_simple = group_name.replace("Source","")
			console.log(feature.properties.most_recent_vn)
			var recent_vn = new Date(feature.properties.most_recent_vn.replace(/-/g, '\/'))
			var today = new Date()
			var duration = Math.round((today - recent_vn) / (1000 * 3600 * 24))
			function differenceInMonths(today, recent_vn) {
				const monthDiff = today.getMonth() - recent_vn.getMonth();
				const yearDiff = today.getYear() - recent_vn.getYear();

				return monthDiff + yearDiff * 12;
			}
			
			if (duration > 365) {
				duration = (today.getYear() - recent_vn.getYear()).toLocaleString()
				duration = duration + "+ YEARS AGO"
			}
			else if (duration > 31 ) {
				duration = differenceInMonths(today, recent_vn).toLocaleString()
				duration = duration + " MONTHS AGO"
			}
			else {
				duration = duration.toLocaleString() + " DAYS AGO"
			}
			
			var recent_vn_str = recent_vn.toLocaleDateString('en-us', {year:"numeric", month:"short"}).toUpperCase()
			// var days_since_last_vn = feature.properties.days_since_last_vn.toLocaleString()
			while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
				coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
			}

			popup.setLngLat(coordinates)
				.setHTML(`<span class="pop-headline-${group_id}">${group_name_simple}</span><div class="pop-body"><span class="pop-facility-name">${headline}</span><br/><div class="pop-violation-count">${violationCount}</div><hr/><span style="font-size:1.3em;"><strong>Last Violation Notice</strong><br/>${duration}</span></div>`)
				.addTo(map);
		}

		function removePopup(e) {
			map.getCanvas().style.cursor = '';
			popup.remove();
		}
	


		map.on('load', function () {
			for (let i = 0; i < infoData.features.length; i++) {
				infoData.features[i]['id'] = i + 1
			}
// Draw Facilities

			datalayer = map.addLayer({
				id: "datalayer",
				type: "circle",
				source: {
					type: "geojson",
					data: infoData,
				},
				paint: {
					'circle-radius': [
						'interpolate', ['exponential',2], ['zoom'], 
						5, ['interpolate', ['linear'],['get', 'violationCount'],
						1, 3,  // When the value is 0, the radius will be 5 pixels
						15, 18,
						35, 25  
						],
						12, ['interpolate', ['linear'], ['get','violationCount'],
						1, 9,
						15, 54,
						35, 75
					],
				],
					'circle-color': ['get', 'color'],
					'circle-opacity':[
						'case',
						['boolean', ['feature-state', 'hover'], false],
							1,
							0.5
						],
				// 	'circle-opacity': [
				// 		'interpolate', ['linear'], ['get','days_since_last_vn'], 
				// 		0, .7,
				// 		1460, 0.1
				// ],
					'circle-opacity-transition': { duration: 300 }, // Smooth transition for opacity changes
					'circle-stroke-color': '#2E333F',  // Outline color
   				    'circle-stroke-width': .7, // Outline thickness
					'circle-stroke-opacity': .8
				}
			});

// these functions control Mouse actions
// they make the pop-up headline or update the article text
			// When we move the mouse over, draw the popup and change the hover style
			map.on('mousemove', 'datalayer', function (e) {
				startHover(e)
				drawPopup(e)
			});

			// When we move the mouse away from a point, turn off the hovering and popup
			map.on('mouseleave', 'datalayer', function (e) {
				stopHover(e)
				removePopup(e)
			});

			
			// When we click, update the article (the right-hand side)
			map.on('click', 'datalayer', function (e) {
				
				updateArticle(e)
				var currentZoom = map.getZoom();
				
				if (currentZoom < 12) {
				map.flyTo({
				center: e.features[0].geometry.coordinates,
				zoom:12,
				});
			}
				else if (currentZoom == 12) {
				map.flyTo({
				center: e.features[0].geometry.coordinates,
				duration: 1000,
				essential: true
				});
			}
				else if (currentZoom > 12) {
				map.flyTo({
				center: e.features[0].geometry.coordinates,
				essential: true,
				duration: 1000
				// zoom:12,
				});
			
			}
			 
			// map.setLayoutProperty(
			// 	'circleSelected',
			// 	'visibility',
			// 	'none'
			// )
			// map.circleSelected.setVisibility(false)
			});
			


// very important!! this automatically centers the map and zooms it
			map.fitBounds(turf.bbox(infoData), { padding: 0, linear: true })
		})
		

	</script>
	<script>
	// this part is J query / with some mapbox JavaScript
	// it changes what is displayed based on the pulldown menu

		var groupsObj = {};

		$(document).ready(function () {
			infoData.features.forEach(function (feature) {
				groupsObj[feature.properties.group_id] = feature.properties.group_name;
			})

			$.each(groupsObj, function (key, value) {
				$('#select-menu')
					.append($("<option></option>")
						.attr("value", value)
						.text(value));
			});

			$('#select-menu').change(function () {
				var selectedGroup = $('#select-menu').val();

				if (!selectedGroup) {
					map.setFilter('datalayer', null);
				} else {
					map.setFilter('datalayer', ['==', ['get', 'group_name'], selectedGroup]);
				}
			});
		});

// Get the Epa Modal
var epaModal = document.getElementById("epaPopup");
// var epaModal2 = document.getElementById("epaPopup2");

// Get the Epa Button that opens the modal
var epaBtn = document.getElementById("epaButton");

// Get the Epa Button that opens the modal
var epaBtn2 = document.getElementById("epaButton2");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];
// var span2 = document.getElementsByClassName("close2")[0];

// When the user clicks the button, open the modal 
epaBtn.onclick = function() {
	epaModal.style.display = "block";
}
// When the user clicks the button, open the modal 
epaBtn2.onclick = function() {
	epaModal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
	epaModal.style.display = "none";
}
// // When the user clicks on <span> (x), close the modal
// span2.onclick = function() {
// 	epaModal2.style.display = "none";
// }
// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == epaModal) {
    epaModal.style.display = "none";
  }
}
	</script>
    <script>

    let newViolations = violationData.features
    let violationDivs = ``
    
    newViolations.forEach((item) => {
        let epa_class = item.properties.group_name
        let group_id = item.properties.group_id
        let facility_name = item.properties.facility_name
        let date_str = item.properties.date_str
		let violation_comment_list = item.properties.comment_list
		let doc_url = item.properties.doc_url
        var geom = item.geometry.coordinates
        var lat = item.properties.lat
        var long = item.properties.long
		var id = item.properties.srn
		var county = item.properties.county
		// let violation_comments = "<ul><li>" + violation_comment_list.join("</li><li>") + "</li></ul>"

		let totalCharacters = 0;

		for (let i = 0; i < violation_comment_list.length; i++) {
		totalCharacters += violation_comment_list[i].length;
		}
		console.log(totalCharacters)

		let violation_comments = "Hi!!!"
		console.log(violation_comment_list.length)

		if (violation_comment_list.length > 1) {
			violation_comments = "<ul><li>" + violation_comment_list.join("</li><li>") + "</li></ul>"
		}
		else {
			violation_comments = violation_comment_list[0]
		}
		
		function limitCharacterLength(inputString, maxLength) {
		if (inputString.length > maxLength) {
			return `<div id="map-link">` + inputString.slice(0, maxLength)+`...<a class="read-more" data-lat="${lat}" data-long="${long}" data-id="${id}">[Read more]</a></p>`; // Truncate the string to the desired length
		}
		return inputString + `</p><div id="map-link">`; // If the string is already within the limit, return it as is
		}

		// // Limit the character length to 200 characters
		const maxLength = 500;
		violation_comments = limitCharacterLength(violation_comments, maxLength);
		
		console.log(violation_comments)
		// console.log(violationCommentTruncated)


        if (group_id == 4){
            var oneDivOpen = `<div class="one-vn"><div class="epa-class-${group_id}"><h3 class="dark">${epa_class}</h3></div>`
        }
        else {
            var oneDivOpen = `<div class="one-vn"><div class="epa-class-${group_id}"><h3>${epa_class}</h3></div>`
        }

		// if (violation_comment_list.length > 1) {
		// 	var oneDivClose = `<div class="snippet"><h5>${county} County</h5><h1>${facility_name}</h1><a href="${doc_url}" target="_blank">${date_str}</a><img class="icon" src="img/doc-link.svg"/><div id="map-link"><p>${violation_comments}<a class="read-more" data-lat="${lat}" data-long="${long}" data-id="${id}">[Read more]</a></p><a class="article" data-lat="${lat}" data-long="${long}" data-id="${id}">View on the map &#8594;</a></div></div></div>`
		// }
			var oneDivClose = `<div class="snippet"><h5>${county} County</h5><h1>${facility_name}</h1><a href="${doc_url}" target="_blank">${date_str}</a><img class="icon" src="img/doc-link.svg"/><p>${violation_comments}<a class="article" data-lat="${lat}" data-long="${long}" data-id="${id}">View on the map &#8594;</a></div></div></div>`

		var oneDiv = oneDivOpen + oneDivClose

        violationDivs = violationDivs + oneDiv

    })
    
    document.getElementById("recent-violations").innerHTML = violationDivs

    $(document).on('click', '#map-link a', function(e) {
        // lngLat = $(this).attr('data-coord')
        // lngLat = $(this).attr(data-geom)
		var id = $(this).attr('data-id')
        var ll = new mapboxgl.LngLat($(this).attr('data-long'), $(this).attr('data-lat'));
        // new LngLat(lng: number, lat: number)
       	map.flyTo({
				center:ll,
				duration:100,
				zoom:12,
        })
		var mapContainer = document.getElementById('map');
		mapContainer.scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
		function findFeatureBySRN(srnToFind) {
			for (var i = 0; i < infoData.features.length; i++) {
				if (infoData.features[i].properties.srn === srnToFind) {
					return infoData.features[i];
				}
			}
			return null; // Return null if the feature with the specified srn is not found
		}
		
		// Usage
		var srnToSearchFor = id; // Replace with the SRN you want to find
		var foundFeature = findFeatureBySRN(srnToSearchFor);
		circleSelected = map.addLayer({
				"id": "circle-selected",
				"type": "circle",
				"source": {
					type: "geojson",
					data: foundFeature,
				},
				paint: {
				'circle-radius': 40,
				'circle-color': "white",
				'circle-opacity':0,
				'circle-stroke-color': 'black',  // Outline color
   			    'circle-stroke-width': 4, // Outline thickness
				'circle-stroke-opacity': .5
				}
		});
		function updateArticle2(foundFeature) {
			let feature = foundFeature
			var group_id = feature.properties.group_id
			var group_name = feature.properties.group_name
            var srn = feature.properties.srn
            var violation_count = feature.properties.violationCount
            var address = feature.properties.address_full
            var facility_name = feature.properties.facility_name
            var violation_article = feature.properties.violation_article

            if (group_id == 4) {
                if (violation_count > 1) {
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class-dark">${group_name}</h3><h3 class="srn-dark">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notices</h2></div><div id="company-violations">${violation_article}</div>`
                }
                else {
                    
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class-dark">${group_name}</h3><h3 class="srn-dark">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notice</h2></div><div id="company-violations">${violation_article}</div>`
                }
            }
            else {
                if (violation_count > 1) {
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class">${group_name}</h3><h3 class="srn">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notices</h2></div><div id="company-violations">${violation_article}</div>`
                }
                else {
                    
                    var article = `<div class="epa-class-${group_id}"><h3 class="epa-class">${group_name}</h3><h3 class="srn">SRN: ${srn}</h3></div><div id="company-profile"><h3>${address}</h3><h1>${facility_name}</h1><h2>${violation_count} Violation Notice</h2></div><div id="company-violations">${violation_article}</div>`
                }
            }

            learn = `<div id='learn'><h4>Want to Learn More About This Facility?</h4><p>Find inspection reports, older violations and other documents for ${facility_name} in <a href="https://www.egle.state.mi.us/aps/downloads/SRN/${srn}" target="_blank">EGLE's database</a>, and use the <a href="https://www.michigan.gov/egle/-/media/Project/Websites/egle/Documents/Programs/AQD/misc-info/file-naming-convention.pdf" target="_blank">file naming conventions</a> to decode the documents (ie "SAR" = "Staff Activity Report", "ENFN" = "Enforcement Notice")</p><p>Explore all documents for permitted sources by browsing this <a href="https://www.tinyurl.com/egle-air-documents" target="_blank">Google sheet.</a> If you're looking for this facility, filter by its State Registration Number (SRN): ${srn}</p></div>`
            document.getElementById("articlePlace").innerHTML = article + learn
			articlePlace.scrollTop = 0
		}
		updateArticle2(foundFeature)
    })
    </script>


</body>

</html>
